name: Lint files

on:
  pull_request:
  push:
    branches: [master]

jobs:
  prek:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      - uses: j178/prek-action@0bb87d7f00b0c99306c8bcb8b8beba1eb581c037 # v1

  detect-apps:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.merged.outputs.all_changed_files }}
      any_changed: ${{ steps.merged.outputs.any_changed }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        id: depth2
        with:
          files: |
            applications/**
            platform/**
          dir_names: "true"
          dir_names_max_depth: "2"
          matrix: "true"

      - uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        id: depth3
        with:
          files: |
            infrastructure/operators/**
            infrastructure/system/**
          dir_names: "true"
          dir_names_max_depth: "3"
          matrix: "true"

      - name: Merge changed dirs
        id: merged
        env:
          D2: ${{ steps.depth2.outputs.all_changed_files }}
          D3: ${{ steps.depth3.outputs.all_changed_files }}
        run: |
          MERGED=$(jq \
            --null-input \
            --compact-output \
            --argjson d2 "$D2" \
            --argjson d3 "$D3" \
            '$d2 + $d3 | unique'
          )
          echo "all_changed_files=$MERGED" >> "$GITHUB_OUTPUT"
          if [ "$(echo "$MERGED" | jq 'length')" -gt 0 ]; then
            echo "any_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
          fi

  kubeconform:
    needs: detect-apps
    if: needs.detect-apps.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ${{ fromJson(needs.detect-apps.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install kustomize
        uses: imranismail/setup-kustomize@2ba527d4d055ab63514ba50a99456fc35684947f # v2

      - name: Install kubeconform
        env:
          KUBECONFORM_VERSION: "0.6.7"
        run: |
          curl \
            --silent \
            --location \
            --output /tmp/kubeconform.tar.gz \
            "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar --extract --file=/tmp/kubeconform.tar.gz --directory=/usr/local/bin kubeconform

      - name: Validate ${{ matrix.directory }}
        run: |
          set -euo pipefail
          kustomize build --enable-helm "${{ matrix.directory }}" | kubeconform \
            --strict \
            --schema-location default \
            --schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            --schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}/{{.ResourceKind}}.json'
